<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Simulador Funil & Pipeline — Jefferson Marim</title>
<style>
  :root{ --totvs:#0069B4; --totvs-2:#005A99; --totvs-3:#0077CC;
    --bg:#eef2f6;--card:#fff;--muted:#64748b;--text:#0f172a;--line:#e5e7eb;
    --brand:var(--totvs); --real:var(--totvs); --prev:#F59E0B; --danger:#DC2626; --ok:#10B981;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
  header{position:sticky;top:0;backdrop-filter:blur(6px);background:#f8fafcdd;border-bottom:1px solid var(--line);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:0;font-weight:800}
  .row{display:grid;gap:12px}
  @media(min-width:720px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:repeat(3,1fr)}.row.cols-4{grid-template-columns:repeat(4,1fr)}.row.cols-5{grid-template-columns:repeat(5,1fr)}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.03);padding:14px}
  .title{font-size:12px;color:var(--muted);font-weight:600;margin-bottom:6px}
  .h-title{font-size:16px;color:#0f172a;font-weight:700;margin:0 0 8px 0}
  .input{height:44px;border:1px solid var(--line);border-radius:12px;padding:0 12px;width:100%}
  .input.pref{padding-left:28px;position:relative}
  .affix{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#94a3b8;font-size:12px}
  .kpi{border-radius:16px;border:1px solid var(--line);padding:14px;background:#fff}
  .kpi .v{font-size:22px;font-weight:800}
  nav{display:inline-flex;border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
  nav a{padding:6px 10px;text-decoration:none;color:inherit;cursor:pointer}
  nav a.active{background:var(--brand);color:#fff}
  .legend{display:flex;gap:12px;font-size:13px;color:#334155;flex-wrap:wrap}
  .legend i{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
  table{border-collapse:separate;border-spacing:0 8px;width:100%}
  th,td{padding:8px 10px;text-align:left}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
  .hidden{display:none!important}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
  .center{display:flex;justify-content:center;align-items:center}
  #err{position:fixed;left:0;right:0;top:0;background:#FEF3C7;color:#7C2D12;border-bottom:1px solid #FDE68A;padding:10px 12px;font-size:14px;display:none;z-index:9999}
  .actions{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div id="err"></div>
<header>
 <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
  <h1>Simulador Funil & Pipeline — Jefferson Marim</h1>
  <div class="actions">
    <button id="btnReset" class="btn">Resetar dados</button>
    <nav id="tabs">
      <a id="tab-sim">Simulador</a>
      <a id="tab-sem">Meta Semanal</a>
      <a id="tab-dash">Dashboards</a>
    </nav>
  </div>
 </div>
</header>
<main class="wrap" id="content"></main>

<script>
var PIE_COLORS=['#0069B4','#F59E0B','#10B981','#8B5CF6','#EF4444','#14B8A6','#84CC16'];
var DONUT_COLORS=['#0069B4','#F59E0B'];

(function(){
'use strict';
function showErr(msg){var el=document.getElementById('err');el.textContent=msg;el.style.display='block';}
window.addEventListener('error', function(e){showErr('Erro: '+(e.message||'')+' @'+(e.filename||'')+':'+(e.lineno||'')+':'+(e.colno||''));});

function BRL(n){return (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function BRN(n){return (Number(n)||0).toLocaleString('pt-BR');}
function toComma(n,d){d=(d==null)?1:d;var v=Number(n)||0;var s=v.toFixed(d).replace('.',',');if(d>0)s=s.replace(/,0+$/,'');return s;}
function parseNum(v){ if(v==null)return 0; var s=String(v).trim().replace(/[^0-9.,-]/g,''); if(!s)return 0; var i=Math.max(s.lastIndexOf(','),s.lastIndexOf('.')); if(i!==-1&&i<s.length-1){var a=s.slice(0,i).replace(/[.,]/g,'');var b=s.slice(i+1).replace(/[.,]/g,'');s=a+'.'+b;}else{s=s.replace(/[.,]/g,'');} var n=parseFloat(s); return isNaN(n)?0:n; }

var root=document.documentElement;
var COLORS={real:getComputedStyle(root).getPropertyValue('--real').trim(),prev:getComputedStyle(root).getPropertyValue('--prev').trim(),mold:'#e2e8f0',text:'#0f172a'};

function clone(o){return JSON.parse(JSON.stringify(o));}
var defaults={
  meta:14000,ticket:9500,l2o:0.085,o2v:0.11,
  origens:[{nome:'Inbound',qtd:22},{nome:'Outbound',qtd:25}],
  leadsConv:0,vendas:0,receita:0,pipeQtde:0,pipeValor:0,
  prev:[0,0,0,0],real:[0,0,0,0],
  simAtivo:false,sim:{}
};
var state=clone(defaults);

function computeBase(meta,ticket,l2o,o2v,origens,leadsConv,vendas,receita,pipeQtde,pipeValor){
  var m=parseNum(meta), t=parseNum(ticket), L2O=Number(l2o)||0, O2V=Number(o2v)||0;
  var totalLeads=0; for(var i=0;i<(origens||[]).length;i++){ totalLeads += parseNum(origens[i].qtd)||0; }
  var txRealL2O= totalLeads>0 ? Math.min(1,(parseNum(leadsConv)||0)/totalLeads) : 0;
  var dealsNovos=totalLeads*L2O*O2V;
  var receitaNovos=dealsNovos*t;
  var pipeReceita=parseNum(pipeValor);
  var clientesPrevistos=Math.round(dealsNovos + Math.round(parseNum(pipeQtde)));
  var receitaPrevista=receitaNovos + pipeReceita;
  var realizado=parseNum(receita);
  var metaRestante=Math.max(0, m - realizado - pipeReceita);
  var cobertura=m>0 ? Math.min(1,(realizado+receitaPrevista)/m) : 0;
  var gap=Math.max(0, m - (realizado+receitaPrevista));
  var leadsNec=(t>0)? Math.ceil((metaRestante/t)/Math.max(1e-9,L2O*O2V)) : 0;
  var oppsNec=Math.ceil(leadsNec*L2O);
  return {m:m,t:t,L2O:L2O,O2V:O2V,totalLeads:totalLeads,txRealL2O:txRealL2O,dealsNovos:dealsNovos,receitaNovos:receitaNovos,pipeReceita:pipeReceita,clientesPrevistos:clientesPrevistos,receitaPrevista:receitaPrevista,realizado:realizado,metaRestante:metaRestante,cobertura:cobertura,gap:gap,leadsNec:leadsNec,oppsNec:oppsNec};
}
function compute(){return computeBase(state.meta,state.ticket,state.l2o,state.o2v,state.origens,state.leadsConv,state.vendas,state.receita,state.pipeQtde,state.pipeValor);}
function computeSim(){
  if(!state.simAtivo)return null;
  var s={meta:state.meta,ticket:(state.sim.ticket!==undefined?state.sim.ticket:state.ticket),
         l2o:(state.sim.l2o!==undefined?state.sim.l2o:state.l2o),
         o2v:(state.sim.o2v!==undefined?state.sim.o2v:state.o2v),
         origens:(state.sim.origens||state.origens.map(function(o){return {nome:o.nome,qtd:o.qtd};})),
         leadsConv:state.leadsConv,vendas:state.vendas,receita:state.receita,
         pipeQtde:state.pipeQtde,pipeValor:(parseNum(state.pipeValor)+parseNum(state.sim.pipelineAdd||0))};
  return computeBase(s.meta,s.ticket,s.l2o,s.o2v,s.origens,s.leadsConv,s.vendas,s.receita,s.pipeQtde,s.pipeValor);
}

/* Charts */
function svgBars(labels,s1,s2,w,h,title){
  w=w||720;h=h||240;var pad={l:44,r:12,t:12,b:34};var max=1;
  for(var i=0;i<s1.length;i++){if(s1[i]>max)max=s1[i];}
  for(var j=0;j<s2.length;j++){if(s2[j]>max)max=s2[j];}
  var gw=(w-pad.l-pad.r)/Math.max(1,labels.length),bw=(gw-12)/2;
  var svg='<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'"><rect x="0" y="0" width="'+w+'" height="'+h+'" fill="#fff"/>';
  for(var k=0;k<labels.length;k++){
    var v1=+s1[k]||0,v2=+s2[k]||0;
    var h1=((h-pad.t-pad.b)*v1)/max,h2=((h-pad.t-pad.b)*v2)/max;
    var x=pad.l+k*gw+6,y1=h-pad.b-h1,y2=h-pad.b-h2;
    svg+='<rect x="'+x+'" y="'+y1+'" width="'+(bw-6)+'" height="'+h1+'" rx="6" fill="'+COLORS.prev+'"></rect>';
    svg+='<rect x="'+(x+bw)+'" y="'+y2+'" width="'+(bw-6)+'" height="'+h2+'" rx="6" fill="'+COLORS.real+'"></rect>';
    svg+='<text x="'+(x+bw/2-3)+'" y="'+(y1-6)+'" text-anchor="middle" font-size="10" fill="'+COLORS.text+'">'+BRN(v1)+'</text>';
    svg+='<text x="'+(x+bw+bw/2-3)+'" y="'+(y2-6)+'" text-anchor="middle" font-size="10" fill="'+COLORS.text+'">'+BRN(v2)+'</text>';
    svg+='<text x="'+(x+gw/2)+'" y="'+(h-10)+'" text-anchor="middle" font-size="10" fill="#334155">'+labels[k]+'</text>';
  }
  svg+='</svg>';
  return '<div class="title">'+(title||'')+'</div>'+svg+'<div class="legend mt8"><span><i style="background:'+COLORS.prev+'"></i>Previsto</span><span><i style="background:'+COLORS.real+'"></i>Realizado</span></div>';
}
function svgDonut(prev,real,size,title){
  prev=Number(prev)||0;real=Number(real)||0; size=size||130;
  var r=size/2-10,cx=size/2,cy=size/2;
  var pct= prev>0 ? (real/prev)*100 : 0;
  var color=(pct>=100)? getComputedStyle(document.documentElement).getPropertyValue('--ok').trim() : getComputedStyle(document.documentElement).getPropertyValue('--real').trim();
  var svg='<svg width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'">'
    +'<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" stroke="#e2e8f0" stroke-width="12" fill="none"/>';
  if(pct>=100){
    svg+='<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" stroke="'+color+'" stroke-width="12" fill="none"/>';
  }else{
    var done=Math.max(0,Math.min(real,prev)),rest=Math.max(0,prev-done);
    function arc(ang,off,color2){
      var x=cx+r*Math.cos(off),y=cy+r*Math.sin(off);
      var x2=cx+r*Math.cos(off+ang),y2=cy+r*Math.sin(off+ang);
      var large=ang>Math.PI?1:0;
      return '<path d="M '+x+' '+y+' A '+r+' '+r+' 0 '+large+' 1 '+x2+' '+y2+'" stroke="'+color2+'" stroke-width="12" fill="none" />';
    }
    var a1=(done/prev)*2*Math.PI,a2=(rest/prev)*2*Math.PI;
    svg+=arc(a1,-Math.PI/2,color)+arc(a2,-Math.PI/2+a1,COLORS.prev);
  }
  svg+='<text x="'+cx+'" y="'+cy+'" text-anchor="middle" dominant-baseline="middle" font-size="16" font-weight="700" fill="'+COLORS.text+'">'+toComma(pct,1)+'%</text></svg>';
  return '<div class="center" style="flex-direction:column">'+svg+'<div class="title">'+(title||'')+'</div></div>';
}
function svgPieBasic(labels, values, size, colors){
  size=size||260; var r=size/2-10, cx=size/2, cy=size/2;
  var total=0; for(var i=0;i<values.length;i++){ total+=(+values[i]||0); } if(total<=0) total=1;
  var start=-Math.PI/2, svg='<svg width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'"><circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="#fff"/>';
  for(var j=0;j<values.length;j++){
    var v=+values[j]||0, ang=(v/total)*2*Math.PI, end=start+ang;
    var x1=cx+r*Math.cos(start), y1=cy+r*Math.sin(start);
    var x2=cx+r*Math.cos(end),   y2=cy+r*Math.sin(end);
    var large=ang>Math.PI?1:0;
    var d='M '+cx+' '+cy+' L '+x1+' '+y1+' A '+r+' '+r+' 0 '+large+' 1 '+x2+' '+y2+' Z';
    svg+='<path d="'+d+'" fill="'+(colors[j%colors.length])+'"></path>';
    start=end;
  }
  svg+='</svg>'; return svg;
}
function barsHoriz(labels, values){
  var w=860,h=260,pad= {l:140,r:20,t:14,b:20};
  var max=1; for(var i=0;i<values.length;i++){ if(values[i]>max) max=values[i]; }
  var rowH = Math.floor((h-pad.t-pad.b)/labels.length);
  var svg='<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'"><rect x="0" y="0" width="'+w+'" height="'+h+'" fill="#fff"/>';
  for(var j=0;j<labels.length;j++){
    var v=values[j]||0;
    var wbar = Math.max(2, (w-pad.l-pad.r)*(v/max));
    var x=pad.l, y=pad.t + j*rowH + 8;
    svg+='<text x="'+(pad.l-10)+'" y="'+(y+8)+'" text-anchor="end" font-size="12" fill="#334155">'+labels[j]+'</text>';
    svg+='<rect x="'+x+'" y="'+(y-8)+'" width="'+wbar+'" height="'+(rowH-12)+'" rx="6" fill="#0069B4"></rect>';
    svg+='<text x="'+(x+wbar+6)+'" y="'+(y+8)+'" font-size="11" fill="#0f172a">'+BRN(Math.round(v))+'</text>';
  }
  svg+='</svg>'; return svg;
}

/* Builders */
function money(label,key){return '<div><div class="title">'+label+'</div><div style="position:relative"><span class="affix">R$</span><input class="input pref" id="i_'+key+'" value=""></div></div>';}
function pct(label,key){return '<div><div class="title">'+label+'</div><div style="position:relative"><input class="input" id="i_'+key+'" value=""/><span class="affix" style="left:auto;right:10px">%</span></div></div>';}
function plain(label,key){return '<div><div class="title">'+label+'</div><input class="input" id="i_'+key+'" value=""></div>';}
function kpi(title,value,sub){return '<div class="kpi"><div class="title">'+title+'</div><div class="v">'+value+'</div>'+(sub?'<div class="title mt8">'+sub+'</div>':'')+'</div>';}

/* Views */
var content=document.getElementById('content');

function simInputs(){
  return ''+
  '<section class="row cols-4">'+
    money('Meta Total (Mensal)','meta')+
    money('Ticket médio (R$)','ticket')+
    pct('Taxa Lead→Oportunidade (%)','l2o')+
    pct('Taxa Oportunidade→Venda (%)','o2v')+
  '</section>'+
  '<section class="row cols-2 mt12">'+
    '<div class="card"><div class="title">Leads por segmento</div><div id="origens"></div><div class="title mt8">Total de Leads: <b id="k_totalLeads">0</b></div><div class="mt12"><button class="btn" id="origens_add">+ Adicionar segmento</button></div></div>'+
    '<div class="card"><div class="title">Leads que viraram Oportunidade</div><div class="row cols-2">'+
      plain('Quantidade','leadsConv')+
      '<div><div class="title">Taxa real</div><div class="row cols-2"><div class="input center" style="background:#f8fafc"><b id="k_txReal">0%</b></div><button id="btnAplicarTaxa" class="btn brand">Aplicar</button></div><div class="title">Atualiza a taxa Lead→Opp (%) com a taxa real acima</div></div>'+
    '</div></div>'+
  '</section>'+
  '<section class="row cols-2 mt12">'+
    '<div class="card"><div class="title">Realizado no Período</div><div class="row cols-2">'+ plain('Vendas realizadas (qtde)','vendas') + money('Receita realizada (R$)','receita') + '</div></div>'+
    '<div class="card"><div class="title">Contas em andamento (Forecast)</div><div class="row cols-2">'+ plain('Contas (qtde)','pipeQtde') + money('Valor total (R$)','pipeValor') + '</div><div class="title mt8">Receita esperada do pipeline: <b id="k_pipe">R$ 0,00</b></div></div>'+
  '</section>';
}
function simKPIs(prefix){
  prefix=prefix||'';
  return ''+
  '<section class="row cols-5 mt12">'+
    kpi('Receita Prevista (Mensal)','<span id="'+prefix+'k_prev">R$ 0,00</span>','Clientes esperados: <span id="'+prefix+'k_cli">0</span>')+
    kpi('Meta Total (Mensal)','<span id="'+prefix+'k_meta">R$ 0,00</span>')+
    kpi('GAP para Meta','<span id="'+prefix+'k_gap" style="color:var(--text)">R$ 0,00</span>','<span id="'+prefix+'k_gapPct">0%</span>')+
    kpi('Conversão média dos leads','<span id="'+prefix+'k_conv">0%</span>','Lead→Opp × Opp→Venda')+
    kpi('Cobertura da meta','<span id="'+prefix+'k_cob">0%</span>','Realizado + Previsto')+
  '</section>'+
  '<section class="row cols-3 mt12">'+
    kpi('Receita Realizada (Mensal)','<span id="'+prefix+'k_real">R$ 0,00</span>','Vendas realizadas: <span id="'+prefix+'k_vendas">0</span>')+
    kpi('Meta Restante (Mensal)','<span id="'+prefix+'k_rest">R$ 0,00</span>','Em clientes: <span id="'+prefix+'k_restCli">0</span>')+
    kpi('Ticket necessário (estimativa)','<span id="'+prefix+'k_ticketNec">R$ 0,00</span>','Para zerar a meta, mantendo conversões')+
  '</section>';
}
function resumoTotalizadores(){
  return '<section class="card mt12"><div class="h-title">Resumo e Totalizadores</div>'
   +'<div class="row cols-5 mt12">'
   + kpi('Leads totais requeridos','<span id="sum_leadsReq">0</span>','Considera pipeline e realizado')
   + kpi('Leads adicionais a gerar','<span id="sum_leadsAdd">0</span>','Totais – informados')
   + kpi('Opps necessárias','<span id="sum_opps">0</span>','Leads × taxa Lead→Opp')
   + kpi('Vendas necessárias','<span id="sum_vendasNec">0</span>','Meta restante ÷ ticket')
   + kpi('Conversão Lead→Opp (real)','<span id="sum_txReal">0%</span>','Base: leads informados')
   +'</div></section>';
}
function extraIndicadores(){
  return '<section class="row cols-3 mt12">'
     + kpi('Taxa global Lead→Venda','<span id="k_txGlobal">0%</span>','L→O × O→V')
     + kpi('Cobertura vs Meta','<span id="k_cob2">0%</span>','Realizado+Previsto ÷ Meta')
     + kpi('Clientes previstos (novos)','<span id="k_cli2">0</span>','A partir dos leads informados')
     + '</section>';
}
function simWhatIf(){
  return ''+
  '<section class="card mt12">'+
    '<div style="display:flex;justify-content:space-between;align-items:center"><div class="h-title">Simulação (What-if)</div><label class="title" style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="sim_toggle"> Ativar simulação</label></div>'+
    '<div id="sim_box" class="mt12 hidden">'+
      '<div class="row cols-2">'+
        '<div class="card">'+
          '<div class="title">Leads (Sim)</div>'+
          '<div id="sim_origens"></div>'+
          '<div class="mt8"><button class="btn" id="sim_copy">Copiar reais → simulação</button> <button class="btn" id="sim_reset">Resetar simulação</button></div>'+
        '</div>'+
        '<div class="card">'+
          '<div class="title">Parâmetros (Sim)</div>'+
          pct('Taxa Lead→Oportunidade (%)','sim_l2o')+
          pct('Taxa Oportunidade→Venda (%)','sim_o2v')+
          money('Ticket médio (R$)','sim_ticket')+
          money('Pipeline adicional (R$)','sim_pipelineAdd')+
        '</div>'+
      '</div>'+
      '<div class="row cols-4 mt12">'+
        kpi('Receita Prevista (Sim)','<span id="sim_prev">R$ 0,00</span>','Δ <span id="sim_deltaR">R$ 0,00</span> vs atual · Clientes: <span id="sim_cli">0</span>')+
        kpi('GAP para Meta (Sim)','<span id="sim_gap" style="color:var(--text)">R$ 0,00</span>')+
        kpi('Cobertura da Meta (Sim)','<span id="sim_cob">0%</span>')+
        kpi('Leads necessários (Sim)','<span id="sim_leadsNec">0</span>','Faltam: <span id="sim_leadsFaltam">0</span>')+
      '</div>'+
    '</div>'+
  '</section>';
}

function setActive(which){
  var tabs=['sim','sem','dash'];
  for(var i=0;i<tabs.length;i++){
    var a=document.getElementById('tab-'+tabs[i]);
    if(a){ if(tabs[i]===which) a.classList.add('active'); else a.classList.remove('active'); }
  }
}

function viewSimulador(){
  setActive('sim');
  content.innerHTML = simInputs() + simKPIs('') + extraIndicadores() + resumoTotalizadores() + simWhatIf();
  function setVal(id,val){var el=document.getElementById('i_'+id);if(!el)return;if(id==='l2o'||id==='o2v'||id==='sim_l2o'||id==='sim_o2v'){el.value=(val===''?'':toComma((Number(val)||0)*100,1));}else{el.value=(val!=null?String(val):'');}}
  setVal('meta',state.meta); setVal('ticket',state.ticket); setVal('l2o',state.l2o); setVal('o2v',state.o2v);
  setVal('leadsConv',state.leadsConv); setVal('vendas',state.vendas); setVal('receita',state.receita); setVal('pipeQtde',state.pipeQtde); setVal('pipeValor',state.pipeValor);

  function renderOrigens(target, arr){
    var box=document.getElementById(target), html='';
    for(var i=0;i<(arr||[]).length;i++){
      var o=arr[i];
      html+='<div class="row cols-2" style="align-items:center;margin-bottom:8px">'
       + '<input class="input" value="'+o.nome+'" data-nome="'+i+'"/>'
       + '<div style="display:flex;gap:8px;align-items:center"><input class="input" value="'+(o.qtd||0)+'" data-qtd="'+i+'" style="width:140px"/><span class="title" style="margin:0 8px">Leads</span><button class="btn" data-del="'+i+'">Remover</button></div>'
       + '</div>';
    }
    box.innerHTML=html;
  }
  renderOrigens('origens',state.origens);

  function bind(id,fn){var el=document.getElementById('i_'+id);if(!el)return;el.oninput=function(e){fn(e.target.value);updateDerived();};}
  bind('meta',function(v){state.meta=v;});
  bind('ticket',function(v){state.ticket=v;});
  bind('l2o',function(v){state.l2o=(v===''? '' : Math.max(0,Math.min(1,parseNum(v)/100)));});
  bind('o2v',function(v){state.o2v=(v===''? '' : Math.max(0,Math.min(1,parseNum(v)/100)));});
  bind('leadsConv',function(v){state.leadsConv=v;});
  bind('vendas',function(v){state.vendas=v;});
  bind('receita',function(v){state.receita=v;});
  bind('pipeQtde',function(v){state.pipeQtde=v;});
  bind('pipeValor',function(v){state.pipeValor=v;});

  var box=document.getElementById('origens');
  box.oninput=function(e){
    var i=e.target.getAttribute('data-nome');var q=e.target.getAttribute('data-qtd');
    if(i!=null){state.origens[+i].nome=e.target.value;}
    if(q!=null){state.origens[+q].qtd=parseNum(e.target.value);}
    updateDerived();
  };
  box.onclick=function(e){var d=e.target.getAttribute('data-del');if(d!=null){state.origens.splice(+d,1);renderOrigens('origens',state.origens);updateDerived();}};
  document.getElementById('origens_add').onclick=function(){state.origens.push({nome:'Outra',qtd:0});renderOrigens('origens',state.origens);updateDerived();};

  var btnAp=document.getElementById('btnAplicarTaxa');if(btnAp)btnAp.onclick=function(){var k=compute();state.l2o=k.txRealL2O;document.getElementById('i_l2o').value=toComma(k.txRealL2O*100,1);updateDerived();};

  // What-if
  var toggle=document.getElementById('sim_toggle'), simBox=document.getElementById('sim_box');
  toggle.checked=!!state.simAtivo; if(state.simAtivo) simBox.classList.remove('hidden'); else simBox.classList.add('hidden');
  function setSimVal(id,val){var el=document.getElementById('i_'+id); if(!el) return; if(id==='sim_l2o'||id==='sim_o2v'){el.value=(val===''?'':toComma((Number(val)||0)*100,1));} else { el.value=(val!=null?String(val):''); }}
  setSimVal('sim_l2o', state.sim.l2o!==undefined?state.sim.l2o:state.l2o);
  setSimVal('sim_o2v', state.sim.o2v!==undefined?state.sim.o2v:state.o2v);
  setSimVal('sim_ticket', state.sim.ticket!==undefined?state.sim.ticket:state.ticket);
  setSimVal('sim_pipelineAdd', state.sim.pipelineAdd||0);
  function renderSimOrigens(){
    var src = state.sim.origens || state.origens.map(function(o){return {nome:o.nome,qtd:o.qtd};});
    var box=document.getElementById('sim_origens'), html='';
    for(var i=0;i<src.length;i++){
      var o=src[i];
      html+='<div class="row cols-2" style="align-items:center;margin-bottom:8px">'
       + '<input class="input" value="'+o.nome+'" data-sim="1" data-nome="'+i+'"/>'
       + '<div style="display:flex;gap:8px;align-items:center"><input class="input" value="'+(o.qtd||0)+'" data-sim="1" data-qtd="'+i+'" style="width:140px"/><span class="title" style="margin:0 8px">Leads</span><button class="btn" data-sim="1" data-del="'+i+'">Remover</button></div>'
       + '</div>';
    }
    box.innerHTML=html;
  }
  renderSimOrigens();

  toggle.onchange=function(){state.simAtivo=this.checked;if(state.simAtivo){simBox.classList.remove('hidden');}else{simBox.classList.add('hidden');}updateDerived();};

  document.getElementById('sim_copy').onclick=function(){
    state.simAtivo=true;
    state.sim={
      origens: state.origens.map(function(o){return {nome:o.nome,qtd:o.qtd};}),
      l2o: state.l2o, o2v: state.o2v, ticket: state.ticket, pipelineAdd: 0
    };
    toggle.checked=true;
    renderSimOrigens();
    setSimVal('sim_l2o', state.sim.l2o); setSimVal('sim_o2v', state.sim.o2v);
    setSimVal('sim_ticket', state.sim.ticket); setSimVal('sim_pipelineAdd', state.sim.pipelineAdd);
    updateDerived();
  };
  document.getElementById('sim_reset').onclick=function(){
    state.simAtivo=true;
    state.sim={origens: (state.origens||[]).map(function(o){return {nome:o.nome,qtd:0};}), l2o:0, o2v:0, ticket:0, pipelineAdd:0};
    toggle.checked=true;
    renderSimOrigens();
    setSimVal('sim_l2o',0); setSimVal('sim_o2v',0); setSimVal('sim_ticket',0); setSimVal('sim_pipelineAdd',0);
    updateDerived();
  };

  function bindSim(id,fn){var el=document.getElementById('i_'+id);if(!el)return;el.oninput=function(e){fn(e.target.value);updateDerived();};}
  bindSim('sim_l2o',function(v){state.sim.l2o=(v===''?'':Math.max(0,Math.min(1,parseNum(v)/100)));});
  bindSim('sim_o2v',function(v){state.sim.o2v=(v===''?'':Math.max(0,Math.min(1,parseNum(v)/100)));});
  bindSim('sim_ticket',function(v){state.sim.ticket=v;});
  bindSim('sim_pipelineAdd',function(v){state.sim.pipelineAdd=v;});

  updateDerived();
}

function updateDerived(){
  var k=compute();
  function set(id,txt){var el=document.getElementById(id);if(el)el.textContent=txt;}
  set('k_totalLeads',BRN(k.totalLeads));
  set('k_txReal',toComma(k.txRealL2O*100,1)+'%');
  set('k_pipe',BRL(k.pipeReceita));
  set('k_prev',BRL(k.receitaPrevista));
  set('k_cli',BRN(k.clientesPrevistos)); set('k_cli2',BRN(k.clientesPrevistos));
  set('k_meta',BRL(k.m));
  var gapEl=document.getElementById('k_gap'); if(gapEl){gapEl.textContent=BRL(k.gap); gapEl.style.color=k.gap>0?'var(--danger)':'var(--text)';}
  set('k_gapPct',toComma((k.gap/Math.max(1,k.m))*100,1)+'%');
  set('k_conv',toComma(k.L2O*100,1)+'% × '+toComma(k.O2V*100,1)+'%');
  set('k_cob',toComma(k.cobertura*100,1)+'%'); set('k_cob2',toComma(k.cobertura*100,1)+'%');
  set('k_txGlobal',toComma(k.L2O*100*k.O2V,1)+'%');
  set('k_real',BRL(k.realizado));
  set('k_vendas',BRN(parseNum(state.vendas)));
  set('k_rest',BRL(k.metaRestante));
  set('k_restCli',k.t>0?BRN(Math.ceil(k.metaRestante/Math.max(1,k.t))):'0');
  var ticketNec=(k.leadsNec>0 && k.L2O>0 && k.O2V>0)? (k.metaRestante/Math.max(1,Math.ceil(k.leadsNec*k.L2O*k.O2V))) : 0;
  set('k_ticketNec',BRL(ticketNec));

  var ks=computeSim();
  if(ks){
    set('sim_prev',BRL(ks.receitaPrevista));
    set('sim_cli',BRN(ks.clientesPrevistos));
    var delta=(ks.receitaPrevista-k.receitaPrevista);
    set('sim_deltaR',(delta>=0?'+ ':'- ')+BRL(Math.abs(delta)));
    var gapSimEl=document.getElementById('sim_gap'); if(gapSimEl){gapSimEl.textContent=BRL(ks.gap); gapSimEl.style.color=ks.gap>0?'var(--danger)':'var(--text)';}
    set('sim_cob',toComma(ks.cobertura*100,1)+'%');
    set('sim_leadsNec',BRN(ks.leadsNec));
    set('sim_leadsFaltam',BRN(Math.max(0,ks.leadsNec-k.totalLeads)));
  }
  set('sum_leadsReq',BRN(k.leadsNec));
  set('sum_leadsAdd',BRN(Math.max(0,k.leadsNec-k.totalLeads)));
  set('sum_opps',BRN(k.oppsNec));
  set('sum_vendasNec',BRN(k.t>0?Math.ceil(k.metaRestante/Math.max(1,k.t)):0));
  set('sum_txReal',toComma(k.txRealL2O*100,1)+'%');
}

/* Dashboards (sem funil; projeção + pizza receita + barras conversão) */

function viewDash(){
  setActive('dash');
  var k=compute();
  function total(a){var s=0; for(var i=0;i<a.length;i++){ s+=parseNum(a[i]||0);} return s;}
  var prevTot = total(state.prev||[0,0,0,0]);
  var realTot = total(state.real||[0,0,0,0]);
  var pctTot  = prevTot>0 ? (realTot/prevTot)*100 : 0;
  var faltTot = Math.max(0, prevTot - realTot);

  var proj = k.realizado + k.receitaPrevista;
  var bate = proj >= k.m;
  var cor = bate ? '#10B981' : '#DC2626';
  var msg = bate ? 'Vai bater a meta' : 'Não bate no ritmo atual';

  // Receita por segmento (pizza)
  var L2O = Number(k.L2O)||0, O2V = Number(k.O2V)||0, t = Number(k.t)||0;
  var labels=[], receitaVals=[];
  for(var i=0;i<(state.origens||[]).length;i++){
    var o=state.origens[i]; var leads=parseNum(o.qtd)||0;
    var vendas = leads * L2O * O2V;
    var receita = vendas * t;
    labels.push(o.nome); receitaVals.push(receita);
  }
  var colors=['#0069B4','#F59E0B','#10B981','#EF4444','#8B5CF6','#14B8A6','#84CC16'];
  function svgPie(labels, values, size, colors){
    size=size||300; var r=size/2-10, cx=size/2, cy=size/2;
    var total=0; for(var i=0;i<values.length;i++){ total+=(+values[i]||0); } if(total<=0) total=1;
    var start=-Math.PI/2, svg='<svg width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'"><circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="#fff"/>';
    for(var j=0;j<values.length;j++){
      var v=+values[j]||0, ang=(v/total)*2*Math.PI, end=start+ang;
      var x1=cx+r*Math.cos(start), y1=cy+r*Math.sin(start);
      var x2=cx+r*Math.cos(end),   y2=cy+r*Math.sin(end);
      var large=ang>Math.PI?1:0;
      var d='M '+cx+' '+cy+' L '+x1+' '+y1+' A '+r+' '+r+' 0 '+large+' 1 '+x2+' '+y2+' Z';
      svg+='<path d="'+d+'" fill="'+(colors[j%colors.length])+'"></path>';
      start=end;
    }
    svg+='</svg>'; return svg;
  }

  // Composição de Receita (barras)
  var barras=(function(){var data=[
        {label:'Realizado',value:k.realizado},
        {label:'Pipeline (esp.)',value:k.pipeReceita},
        {label:'Previsto (novos)',value:k.receitaNovos},
        {label:'Faltante',value:Math.max(0,k.m-(k.realizado+k.pipeReceita+k.receitaNovos))}
      ];var w=900,h=260,pad={l:44,r:12,t:12,b:34};var max=1;for(var i=0;i<data.length;i++){if(data[i].value>max)max=data[i].value;}
      var bw=(w-pad.l-pad.r)/data.length;var svg='<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'"><rect x="0" y="0" width="'+w+'" height="'+h+'" fill="#fff"/>';
      var palette=['#0069B4','#005A99','#0077CC','#F59E0B'];
      for(var i=0;i<data.length;i++){var v=data[i].value,h1=((h-pad.t-pad.b)*v)/max,x=pad.l+i*bw+6,y=h-pad.b-h1,fill=palette[i%palette.length],inside=h1>=20;
        svg+='<rect x="'+x+'" y="'+y+'" width="'+(bw-12)+'" height="'+h1+'" rx="6" fill="'+fill+'"></rect>';
        svg+='<text x="'+(x+(bw-12)/2)+'" y="'+(inside? y+14 : y-6)+'" text-anchor="middle" font-size="11" font-weight="600" fill="'+(inside?'#fff':'#0f172a')+'">'+BRL(v)+'</text>';
        svg+='<text x="'+(x+(bw-12)/2)+'" y="'+(h-10)+'" text-anchor="middle" font-size="10" fill="#334155">'+data[i].label+'</text>';
      } svg+='</svg>'; return svg; })();

  var pieReceita = svgPie(labels, receitaVals, 300, colors);

  var html='';
  html+= '<h3 class="h-title">Indicadores Reuniões Semanais</h3>';
  html+= '<section class="row cols-4">'
      + kpi('Previsto Total (Semanal)','<span>'+BRN(prevTot)+'</span>')
      + kpi('Realizado Total (Semanal)','<span>'+BRN(realTot)+'</span>')
      + kpi('% Atingimento (Semanal)','<span>'+toComma(pctTot,1)+'%</span>')
      + kpi('Faltante (Semanal)','<span>'+BRN(faltTot)+'</span>')
    + '</section>';

  html+= '<h3 class="h-title mt12">Indicadores Meta Mensal</h3>';
  html+= '<section class="card mt8"><div class="h-title">Projeção de Fechamento</div><div class="row cols-3">'
       + kpi('Projeção','<span>'+BRL(proj)+'</span>')
       + kpi('Meta','<span>'+BRL(k.m)+'</span>')
       + kpi('Status','<span style="color:'+cor+';font-weight:800">'+msg+'</span>')
       + '</div></section>';

  html+= '<section class="card mt12"><div class="h-title">Composição de Receita</div>'+barras+'</section>';

  
  // ===== Cobertura da Meta + Leads por Segmento (fix safe concatenation) =====
  (function(){
    var coberto  = (k.realizado || 0) + (k.receitaPrevista || 0);
    var faltante = Math.max((k.m || 0) - coberto, 0);
    var totalD   = Math.max((k.m || 0), coberto + faltante, 1);
    var pCob     = (coberto/totalD)*100;
    var pFal     = (faltante/totalD)*100;

    var donutSvg = svgDonut(k.m, coberto, 220);
    var donutLegend = ''
      + '<div class="legend" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:10px;">'
      +   '<span><i style="background:'+DONUT_COLORS[0]+';width:10px;height:10px;border-radius:2px;display:inline-block"></i> '
      +     'Realizado + Previsto: ' + BRL(coberto) + ' (' + toComma(pCob,1) + '%)'
      +   '</span>'
      +   '<span><i style="background:'+DONUT_COLORS[1]+';width:10px;height:10px;border-radius:2px;display:inline-block"></i> '
      +     'Faltante: ' + BRL(faltante) + ' (' + toComma(pFal,1) + '%)'
      +   '</span>'
      + '</div>';

    var arrSeg   = (state.origens || state.segs || []);
    var labels   = [];
    var leadVals = [];
    for (var i=0; i<arrSeg.length; i++){
      labels.push(arrSeg[i].nome || arrSeg[i].name || ('Segmento '+(i+1)));
      leadVals.push(+arrSeg[i].qtd || +arrSeg[i].value || 0);
    }
    var totalL = 0; for (var j=0;j<leadVals.length;j++){ totalL += leadVals[j]; }
    if (totalL <= 0) totalL = 1;

    var pieLeadsSvg;
    try { pieLeadsSvg = svgPie(labels, leadVals, 300, typeof PIE_COLORS!=='undefined'?PIE_COLORS:undefined); }
    catch(e){ pieLeadsSvg = svgPie(labels, leadVals, 300); }

    var pieLegend = '<div class="legend" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:10px;">';
    for (var k2=0; k2<labels.length; k2++){
      var v  = leadVals[k2] || 0;
      var pc = (v/totalL)*100;
      var col = (typeof PIE_COLORS!=='undefined') ? PIE_COLORS[k2 % PIE_COLORS.length] : '#0069B4';
      pieLegend += '<span><i style="background:'+col+';width:10px;height:10px;border-radius:2px;display:inline-block"></i> '
                +  labels[k2] + ': ' + toComma(v,0) + ' (' + toComma(pc,1) + '%)'
                + '</span>';
    }
    pieLegend += '</div>';

    html += '<section class="row cols-2 mt12">'
         +    '<div class="card"><div class="h-title">Cobertura da Meta</div><div class="center">'+ donutSvg +'</div>' + donutLegend + '</div>'
         +    '<div class="card"><div class="h-title">Leads por Segmento (Estimado)</div><div class="center">'+ pieLeadsSvg +'</div>' + pieLegend + '</div>'
         +  '</section>';
  })();


  content.innerHTML=html;
}
/* Meta Semanal */
var semanalDOM=null;
function renderSemanalOnce(){
  setActive('sem');
  var weeks=['Semana 1','Semana 2','Semana 3','Semana 4'];
  var html='';
  html+='<section class="card">';
  html+='<div class="h-title">Meta Semanal — Leads (Global)</div>';
  html+='<div style="overflow:auto"><table><thead><tr class="title"><th></th>';
  for(var w=0; w<weeks.length; w++){ html+='<th>'+weeks[w]+'</th>'; }
  html+='<th>Total</th></tr></thead><tbody>';
  html+='<tr style="background:#f8fafc"><td class="title" style="color:#334155">Previsto</td>';
  for(var i=0;i<4;i++){ html+='<td><input class="input" id="prev_'+i+'" style="width:120px" value="'+(state.prev[i]||0)+'"></td>'; }
  html+='<td class="title" id="totPrev">0</td></tr>';
  html+='<tr style="background:#f8fafc"><td class="title" style="color:#334155">Realizado</td>';
  for(var j=0;j<4;j++){ html+='<td><input class="input" id="real_'+j+'" style="width:120px" value="'+(state.real[j]||0)+'"></td>'; }
  html+='<td class="title" id="totReal">0</td></tr>';
  html+='<tr><td class="title" style="color:#334155">Atingimento (%)</td>';
  for(var k=0;k<4;k++){ html+='<td class="title" id="pct_'+k+'">0%</td>'; }
  html+='<td class="title" id="pctTot">0%</td></tr>';
  html+='</tbody></table></div>';
  html+='</section>';
  html+='<section class="card mt12">';
  html+='<div class="h-title">Consolidado do Mês</div>';
  html+='<div class="row cols-4">'
    + kpi('Previsto Total','<span id="sem_prevTot">0</span>')
    + kpi('Realizado Total','<span id="sem_realTot">0</span>')
    + kpi('Atingimento Geral','<span id="sem_pctTot">0%</span>')
    + kpi('Faltante Total','<span id="sem_faltante">0</span>')
    + '</div>';
  html+='</section>';
  html+='<section class="card mt12">';
  html+='<div class="h-title">Cobertura por Semana</div>';
  html+='<div class="row cols-4" id="donuts"></div>';
  html+='<div class="legend mt8"><span><i style="background:'+COLORS.real+'"></i>Realizado</span><span><i style="background:'+COLORS.prev+'"></i>Previsto (restante)</span><span><i style="background:#10B981"></i>>=100%</span></div>';
  html+='<div class="mt12" id="barras"></div>';
  html+='</section>';
  content.innerHTML=html;
  semanalDOM={
    prev:[document.getElementById('prev_0'),document.getElementById('prev_1'),document.getElementById('prev_2'),document.getElementById('prev_3')],
    real:[document.getElementById('real_0'),document.getElementById('real_1'),document.getElementById('real_2'),document.getElementById('real_3')],
    totPrev:document.getElementById('totPrev'),totReal:document.getElementById('totReal'),
    pct:[document.getElementById('pct_0'),document.getElementById('pct_1'),document.getElementById('pct_2'),document.getElementById('pct_3')],
    pctTot:document.getElementById('pctTot'), donuts:document.getElementById('donuts'), barras:document.getElementById('barras'),
    prevTot:document.getElementById('sem_prevTot'), realTot:document.getElementById('sem_realTot'), pctGeral:document.getElementById('sem_pctTot'), faltante:document.getElementById('sem_faltante')
  };
  var attach = function(el, idx, arrName){
    el.addEventListener('input', function(e){ state[arrName][idx]=parseNum(e.target.value); updateSemanalComputed(); });
  };
  for(var i2=0;i2<4;i2++){ attach(semanalDOM.prev[i2], i2, 'prev'); attach(semanalDOM.real[i2], i2, 'real'); }
  updateSemanalComputed();
}
function updateSemanalComputed(){
  function total(a){var s=0;for(var i=0;i<a.length;i++){s+=parseNum(a[i]||0);}return s;}
  var weeks=['Semana 1','Semana 2','Semana 3','Semana 4'];
  var prev=state.prev.slice(0,4), real=state.real.slice(0,4);
  var totP=total(prev), totR=total(real), falt=Math.max(0, totP-totR);
  semanalDOM.totPrev.textContent=BRN(totP); semanalDOM.totReal.textContent=BRN(totR);
  for(var i=0;i<4;i++){ var p=parseNum(prev[i]), r=parseNum(real[i]); var pct = p>0 ? (r/p)*100 : 0; semanalDOM.pct[i].textContent=toComma(pct,1)+'%'; }
  var pctTot=totP>0?(totR/totP)*100:0; semanalDOM.pctTot.textContent=toComma(pctTot,1)+'%';
  semanalDOM.prevTot.textContent=BRN(totP); semanalDOM.realTot.textContent=BRN(totR); semanalDOM.pctGeral.textContent=toComma(pctTot,1)+'%'; semanalDOM.faltante.textContent=BRN(falt);
  var donutsHTML=''; for(var d=0;d<4;d++){ donutsHTML+=svgDonut(prev[d], real[d], 140, weeks[d]); }
  semanalDOM.donuts.innerHTML=donutsHTML;
  semanalDOM.barras.innerHTML=svgBars(weeks, prev, real, 900,240, 'Previsto × Realizado (Barras)');
}

function viewSemanal(){ renderSemanalOnce(); }

/* Reset + Tab binding */
//function resetAll(){ state = clone(defaults); viewSimulador(); }
// Reset TOTAL deixando os inputs em branco (não para os defaults)
function resetAll(){
  // mantemos os nomes já existentes dos segmentos
  var nomes = (state && state.origens ? state.origens.map(o => o.nome)
                                      : ['Inbound','Outbound']);

  state = {
    // principais
    meta: '',            // em branco
    ticket: '',          // em branco
    l2o: '',             // em branco (Taxa Lead→Opp %)
    o2v: '',             // em branco (Taxa Opp→Venda %)

    // segmentos (mantém nomes, zera quantidades)
    origens: nomes.map(n => ({ nome: n, qtd: '' })),

    // realizado / pipeline
    leadsConv: '',       // qtd que virou opp (para taxa real)
    vendas: '',          // qtd
    receita: '',         // R$
    pipeQtde: '',        // qtd
    pipeValor: '',       // R$

    // metas semanais
    prev: ['', '', '', ''],
    real: ['', '', '', ''],

    // simulação
    simAtivo: false,
    sim: {}
  };

  // re-renderiza a aba que estiver ativa
  var aba = (document.querySelector('nav a.active')?.id || 'tab-sim').replace('tab-','');
  if      (aba === 'sem')  { viewSemanal(); }
  else if (aba === 'dash') { viewDash(); }
  else                     { viewSimulador(); }

  // sobe página
  try { window.scrollTo({top:0, behavior:'instant'}); } catch(e){ window.scrollTo(0,0); }
}
document.getElementById('btnReset').onclick = resetAll;
document.getElementById('tab-sim').onclick = viewSimulador;
document.getElementById('tab-sem').onclick = viewSemanal;
document.getElementById('tab-dash').onclick = viewDash;

/* First render (no hash required) */
viewSimulador();
})();</script>
</body>
</html>
